<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <base href="../">
  <title>BeVoys - Etkinlik Detayı</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css?v=20260223a">
</head>
<body>
  <div class="app">
    <header class="mobile-header">
      <a href="etkinlikler/" class="back-btn" aria-label="Geri">
        <i data-lucide="arrow-left" aria-hidden="true"></i>
      </a>
      <h1>Etkinlik Detayı</h1>
    </header>

    <main class="page-content">
      <div style="display:flex; align-items:center; gap:var(--spacing-lg); margin-bottom:var(--spacing-2xl);" class="desktop-only-flex">
        <a href="etkinlikler/" aria-label="Geri" style="color:var(--text-primary); display:none;" class="desktop-back">
          <i data-lucide="arrow-left" aria-hidden="true" style="font-size:24px;"></i>
        </a>
        <h1 class="desktop-title" style="margin-bottom:0;">Etkinlik Detayı</h1>
      </div>

      <div id="detay-content">
        <!-- JS ile doldurulacak -->
      </div>
    </main>
  </div>

  <style>
    @media (min-width: 768px) {
      .desktop-back { display: flex !important; }
      .desktop-only-flex { display: flex !important; }
    }
  </style>

  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
  <script src="js/data.js?v=20260223a"></script>
  <script src="js/components.js?v=20260223a"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const container = document.getElementById('detay-content');
      const id = getParam('id');

      if (!id) {
        container.textContent = 'Etkinlik bulunamadı.';
        return;
      }

      BeVoysComponents.showLoading(container);
      const etkinlik = await BeVoysData.getEtkinlik(id);

      if (!etkinlik) {
        container.textContent = '';
        const empty = BeVoysComponents.createElement('div', { className: 'empty-state' });
        empty.appendChild(BeVoysComponents.createIcon('calendar-x'));
        empty.appendChild(BeVoysComponents.createElement('p', { textContent: 'Etkinlik bulunamadı', className: 'text-secondary' }));
        container.appendChild(empty);
        BeVoysComponents.refreshIcons();
        return;
      }

      container.textContent = '';

      // Detail card
      const card = BeVoysComponents.createElement('div', { className: 'detail-card' });

      // Header
      const header = BeVoysComponents.createElement('div', { className: 'detail-card-header' });
      header.appendChild(BeVoysComponents.createElement('h2', { textContent: etkinlik.baslik }));
      card.appendChild(header);

      // Body
      const body = BeVoysComponents.createElement('div', { className: 'detail-card-body' });

      // Source badge
      const kaynakClass = etkinlik.kaynak === 'resmi' ? 'resmi' : 'topluluk';
      const kaynakIcon = etkinlik.kaynak === 'resmi' ? 'building-2' : 'user';
      const kaynakLabel = etkinlik.kaynak === 'resmi'
        ? (etkinlik.kurum || 'Resmi') + ' - Resmi Kurum Etkinliği'
        : 'Topluluk Etkinliği';

      const sourceBadge = BeVoysComponents.createElement('div', { className: 'source-badge ' + kaynakClass });
      sourceBadge.appendChild(BeVoysComponents.createIcon(kaynakIcon));
      sourceBadge.appendChild(document.createTextNode(kaynakLabel));
      body.appendChild(sourceBadge);

      // Info rows
      const infoData = [
        { icon: 'map-pin', label: 'Konum', value: etkinlik.konum },
        { icon: 'accessibility', label: 'Engel Türü', value: etkinlik.engelTuru },
        { icon: 'calendar', label: 'Tarih', value: formatTarih(etkinlik.tarih) + ' - ' + etkinlik.saat },
        { icon: 'user', label: 'Organizatör', value: etkinlik.organizator || etkinlik.kurum || '-' },
        { icon: 'mail', label: 'İletişim', value: [etkinlik.eposta, etkinlik.telefon].filter(Boolean).join(' • ') || '-' },
        { icon: 'monitor', label: 'Etkinlik Şekli', value: etkinlik.tur || 'Yüz Yüze' }
      ];

      infoData.forEach((info, i) => {
        const row = BeVoysComponents.createElement('div', { className: 'info-row' });
        row.appendChild(BeVoysComponents.createIcon(info.icon));

        const content = BeVoysComponents.createElement('div', { className: 'info-row-content' });
        content.appendChild(BeVoysComponents.createElement('span', { className: 'info-row-label', textContent: info.label }));
        content.appendChild(BeVoysComponents.createElement('span', { className: 'info-row-value', textContent: info.value }));
        row.appendChild(content);
        body.appendChild(row);

        if (i < infoData.length - 1) {
          body.appendChild(BeVoysComponents.createElement('div', { className: 'divider' }));
        }
      });

      // Divider + Açıklama
      body.appendChild(BeVoysComponents.createElement('div', { className: 'divider' }));
      body.appendChild(BeVoysComponents.createElement('span', { className: 'info-row-label', textContent: 'Açıklama' }));

      const descP = BeVoysComponents.createElement('p', {
        textContent: etkinlik.aciklama,
        className: 'info-row-value'
      });
      descP.style.lineHeight = '1.6';
      body.appendChild(descP);

      // Etkinlik Linki (if available)
      const eventLink = etkinlik.link || etkinlik.etkinlikLinki;
      if (eventLink) {
        body.appendChild(BeVoysComponents.createElement('div', { className: 'divider' }));
        const linkRow = BeVoysComponents.createElement('div', { className: 'info-row' });
        linkRow.appendChild(BeVoysComponents.createIcon('external-link'));
        const linkContent = BeVoysComponents.createElement('div', { className: 'info-row-content' });
        linkContent.appendChild(BeVoysComponents.createElement('span', { className: 'info-row-label', textContent: 'Etkinlik Linki' }));
        const linkAnchor = BeVoysComponents.createElement('a', {
          className: 'info-row-link',
          href: eventLink,
          target: '_blank',
          rel: 'noopener noreferrer'
        });
        let shortUrl = eventLink.replace(/^https?:\/\/(www\.)?/, '');
        if (shortUrl.length > 50) shortUrl = shortUrl.substring(0, 50) + '...';
        linkAnchor.textContent = shortUrl;
        linkContent.appendChild(linkAnchor);
        linkRow.appendChild(linkContent);
        body.appendChild(linkRow);
      }

      // Sosyal Medya (if available)
      if (etkinlik.sosyalMedya) {
        body.appendChild(BeVoysComponents.createElement('div', { className: 'divider' }));
        const smRow = BeVoysComponents.createElement('div', { className: 'info-row' });
        smRow.appendChild(BeVoysComponents.createIcon('share-2'));
        const smContent = BeVoysComponents.createElement('div', { className: 'info-row-content' });
        smContent.appendChild(BeVoysComponents.createElement('span', { className: 'info-row-label', textContent: 'Sosyal Medya' }));
        const smUrl = etkinlik.sosyalMedya.startsWith('http') ? etkinlik.sosyalMedya : 'https://' + etkinlik.sosyalMedya;
        const smAnchor = BeVoysComponents.createElement('a', {
          className: 'info-row-link',
          href: smUrl,
          target: '_blank',
          rel: 'noopener noreferrer',
          textContent: etkinlik.sosyalMedya
        });
        smContent.appendChild(smAnchor);
        smRow.appendChild(smContent);
        body.appendChild(smRow);
      }

      // Haritada Aç butonu
      const mapBtn = BeVoysComponents.createElement('a', {
        className: 'btn btn-primary',
        href: 'https://maps.google.com/?q=' + encodeURIComponent(etkinlik.konum),
        target: '_blank',
        rel: 'noopener noreferrer'
      });
      mapBtn.appendChild(BeVoysComponents.createIcon('map'));
      mapBtn.appendChild(document.createTextNode('Haritada Aç'));
      body.appendChild(mapBtn);

      // Participant section
      let currentKatilimci = parseInt(etkinlik.katilimciSayisi) || 0;
      const partSection = BeVoysComponents.createElement('div', { className: 'participant-section' });
      if (currentKatilimci === 0) partSection.style.display = 'none';

      const partHeader = BeVoysComponents.createElement('div', { className: 'participant-header' });
      partHeader.appendChild(BeVoysComponents.createIcon('users'));
      const partCountSpan = BeVoysComponents.createElement('span', {
        textContent: currentKatilimci + ' kişi gitmek istiyor'
      });
      partHeader.appendChild(partCountSpan);
      partSection.appendChild(partHeader);

      // Avatar circles
      const avatarRow = BeVoysComponents.createElement('div', { className: 'avatar-row' });
      const colors = ['#8B9A3B', '#5B9BD5', '#4CAF50', '#FFC107', '#808070', '#E85555'];
      function renderAvatars(count) {
        avatarRow.textContent = '';
        const visible = Math.min(count, 6);
        for (let i = 0; i < visible; i++) {
          const circle = BeVoysComponents.createElement('div', { className: 'avatar-circle' });
          circle.style.backgroundColor = colors[i % colors.length];
          avatarRow.appendChild(circle);
        }
      }
      renderAvatars(currentKatilimci);
      partSection.appendChild(avatarRow);
      body.appendChild(partSection);

      // Ben de Gidiyorum butonu
      const birlikteBtn = BeVoysComponents.createElement('button', { className: 'btn btn-birlikte' });
      birlikteBtn.appendChild(BeVoysComponents.createIcon('hand-heart'));
      birlikteBtn.appendChild(document.createTextNode('Ben de Gidiyorum'));
      birlikteBtn.addEventListener('click', async () => {
        birlikteBtn.disabled = true;
        birlikteBtn.textContent = 'Gönderiliyor...';
        try {
          await BeVoysData.birlikteGit({ etkinlikId: etkinlik.id, etkinlikBaslik: etkinlik.baslik });
          BeVoysComponents.showToast('Ekleme başarılı!', 'success');
          birlikteBtn.textContent = 'Ekleme Başarılı';

          // Katılımcı sayısını güncelle
          currentKatilimci++;
          partCountSpan.textContent = currentKatilimci + ' kişi gitmek istiyor';

          // Yeni avatar ekle (animasyonlu)
          if (currentKatilimci <= 6) {
            const circle = BeVoysComponents.createElement('div', { className: 'avatar-circle avatar-new' });
            circle.style.backgroundColor = colors[(currentKatilimci - 1) % colors.length];
            avatarRow.appendChild(circle);
          } else {
            let moreSpan = avatarRow.querySelector('.avatar-more');
            if (!moreSpan) {
              moreSpan = BeVoysComponents.createElement('span', { className: 'avatar-more' });
              avatarRow.appendChild(moreSpan);
            }
            moreSpan.textContent = '+' + (currentKatilimci - 6);
          }

          partSection.style.display = '';
          BeVoysComponents.refreshIcons();
        } catch (err) {
          BeVoysComponents.showToast('Bir hata oluştu, tekrar deneyin.', 'error');
          birlikteBtn.disabled = false;
          birlikteBtn.textContent = '';
          birlikteBtn.appendChild(BeVoysComponents.createIcon('hand-heart'));
          birlikteBtn.appendChild(document.createTextNode('Ben de Gidiyorum'));
          BeVoysComponents.refreshIcons();
        }
      });
      body.appendChild(birlikteBtn);

      card.appendChild(body);
      container.appendChild(card);
      BeVoysComponents.refreshIcons();
    });
  </script>
</body>
</html>
